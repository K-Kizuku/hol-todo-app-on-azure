[READMEに戻る](../README.md)
# 環境構築
## Githubからコードをcloneする
ターミナルでデスクトップに移動し、リポジトリをローカルPCにクローンします。

ターミナルで以下のコマンドを実行してください。 【クローンするディレクトリに注意】

```
cd Desktop
git clone リポジトリのURL
```

## VSCodeを開く
クローンしたフォルダに移動し、VSCodeで開く。

ターミナルで以下のコマンドを実行してください。

```
cd hol-todo-app-on-azure
code .
```

## ブランチの切り替え
今回は、環境構築、デプロイ、CI/CD、ToDoアプリ作成の単位でブランチを切り替えます。

ターミナルを開き、以下のコマンドでmkenv(make env:環境構築)のブランチを作成し移動します。
```
git checkout -b mkenv
```

----

## プロジェクト&アプリ作成

* Djangoプロジェクト作成
* Djangoアプリ作成


以下のコマンドでpythonイメージから作成されたコンテナでDjangoのプロジェクトを作成します。
```
docker compose run web django-admin.py startproject hosinoproject .
```
以下のコマンドでDjangoのアプリを作成します。
```
docker compose run web django-admin.py startapp hosinoapp 
```
----

## シェルスクリプト実行権限付与
docker-compose.ymlがstartup.shを実行できるように権限を付与します。
```
chmod +x startup.sh 
```

----
## 環境変数の設定
SECRET_KEYは公開してはいけないので環境変数を使います。

**settings.py** の SECRET_KEY を **docker-compose.yml** の SECRET_KEY に記述します。

↓docker-compose.yml
```
environment:
      - SECRET_KEY= ここにsettings.pyに書いてあるSECRET_KEYを記述
```

↓settings.py
```
import environ
import os

env = environ.Env()
env.read_env(os.path.join('.env'))
:
SECRET_KEY = env('SECRET_KEY')
```

## docker-compose.ymlをGit管理から外す
.gitignoreの1番下に書かれている「docker-compose.yml」のコメントを外します。

※docker-compose.ymlはSECRET_KEYが書かれており、公開してはいけません。

↓.gitignore
```
docker-compose.yml
```

----

## プロジェクトの設定を変更
ホストヘッダー攻撃対策で、ALLOWED_HOSTSにはWebサービスを提供するドメイン名を指定する必要があります。ついでに言語とタイムゾーンも指定。
```
ALLOWED_HOSTS = ['*']
:
LANGUAGE_CODE = 'ja'
TIME_ZONE = 'Asia/Tokyo'
```

## サーバ起動用スクリプト
Django サーバを起動するためにDockerfileのコメントアウトを外します。shファイルにはサーバを起動するコマンドが書かれています。


↓Dockerfile
```
RUN chmod 744 ./startup.sh
ENTRYPOINT ["./startup.sh"]
```

## ロケット打ち上げ
以下のコマンドを実行し、ロケットが打ち上がったら成功です。
```
docker compose build 
docker compose up
```

サーバ停止： control + c
```
docker compose down
```


----
# 次へ
次はデプロイです。

ブランチを切り替えて、次へ進みましょう。
```
git add .
git commit -m "mkenv done"
git push
git checkout -b deploy
```

[デプロイの資料](https://github.com/takatoshiinaoka/hosino-todo/tree/%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4)












